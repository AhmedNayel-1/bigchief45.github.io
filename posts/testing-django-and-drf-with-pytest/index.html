<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.52" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Testing Django and DRF With Pytest &middot; Andrés Álvarez</title>

  
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/hyde.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/extra.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/overrides.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Andrés Álvarez" />

  
</head>

  <body class="theme-base-08 ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://aalvarez.me/"><h1>Andrés Álvarez</h1></a>
      <p class="lead">
       Software Engineer &amp; Web Developer 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="http://aalvarez.me/">Home</a> </li>
        <li><a href="/tags/">Tags</a></li>
        <li><a href="/about/"> About Me </a></li><li><a href="/portfolio/"> Portfolio </a></li>
      </ul>
    </nav>

    
    <ul id="social-media" class="list-inline">
      
        <li>
           <a href="mailto:andresalvarez353@gmail.com" target="_blank"><i class="fa fa-envelope fa-2x" title="E-Mail"></i></a>
        </li>
      

      
        <li>
          <a href="https://linkedin.com/in/aalvarez4" target="_blank"><i class="fa fa-linkedin fa-2x" title="LinkedIn"></i></a>
        </li>
      

      
        <li>
          <a href="https://github.com/BigChief45" target="_blank"><i class="fa fa-github fa-2x" title="Github"></i></a>
        </li>
      

      
        <li>
          <a href="https://www.instagram.com/aalvarez300" target="_blank"><i class="fa fa-instagram fa-2x" title="Instagram"></i></a>
        </li>
      

      
        <li>
          <a href="/feed.xml" target="_blank"><i class="fa fa-rss fa-2x" title="RSS"></i></a>
        </li>
      
    </ul>

    <p>&copy; 2018. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Testing Django and DRF With Pytest</h1>
  <time datetime=2018-02-09T00:00:00Z class="post-date">Fri, Feb 9, 2018</time>

  <p><a href="https://docs.pytest.org/en/latest/contents.html">Pytest</a> has become my favorite Python testing framework. And in this article I want to go over on how I learned to write nice tests for Django and <a href="http://www.django-rest-framework.org/">Django REST Framework</a>.</p>

<p>We will be using the following tools:</p>

<ul>
<li><a href="https://docs.pytest.org/en/latest/contents.html">Pytest</a>: Python testing framework</li>
<li><a href="https://pytest-django.readthedocs.io/">pytest-django</a>: Pytest extensions for Django</li>
<li><a href="https://factoryboy.readthedocs.io/">factoryboy</a>: Factories for easy test data generation.</li>
</ul>

<h2 id="setting-up-pytest-in-a-django-project">Setting Up Pytest in a Django Project</h2>

<p>There are different ways you can setup pytest in a Django project:</p>

<ul>
<li>Use a <code>pytest.ini</code> config file at the root of your project.</li>
<li>Use a <code>conftest.py</code> file in your tests directory where you can use Python to define configuration and fixtures.</li>
</ul>

<p>I will be using the first and simplest approach. You can create a <code>pytest.ini</code> file at the root of your project and define where your Django settings module is:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#080;font-weight:bold">[pytest]</span>
<span style="color:#00c">DJANGO_SETTINGS_MODULE</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">myproject.settings.dev</span></code></pre></div>
<h2 id="testing-django">Testing Django</h2>

<p>I&rsquo;ll first start with Django and then we&rsquo;ll take a look at Django REST Framework. To start, we will want to add some unit tests for our models and integration tests for our views. After that we can take a look on how to test other stuff such as middleware and custom commands.</p>

<h3 id="django-tests-structure">Django Tests Structure</h3>

<p>Your Django application comes with a default <code>test.py</code> file. I usually remove this file and create a <code>tests/</code> directory inside every app of my project.</p>

<p>Inside this directory I will place all the different tests I write, in different subdirectories depending on the type of test. This is what I usually use as reference:</p>

<ul>
<li><code>unit</code>: The most basic and fastest tests. Usually for models and pieces of code that can be interacted with directly.</li>
<li><code>integration</code>: Usually for views. These tests usually consists of a factory or client that will perform the request or interaction to the view.</li>
</ul>

<h3 id="model-unit-tests">Model Unit Tests</h3>

<p>These are the easiest tests. For illustrative purposes, supppose I have the following model:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">Bank</span>:
    name <span style="color:#333">=</span> models<span style="color:#333">.</span>CharField(_(<span style="background-color:#fff0f0">&#39;Name&#39;</span>), max_length<span style="color:#333">=</span><span style="color:#00d;font-weight:bold">20</span>, unique<span style="color:#333">=</span>True)
    managers <span style="color:#333">=</span> models<span style="color:#333">.</span>ManyToManyField(Manager, blank<span style="color:#333">=</span>True)
    employees <span style="color:#333">=</span> models<span style="color:#333">.</span>ManyToManyField(Employee, blank<span style="color:#333">=</span>True)
    interns <span style="color:#333">=</span> models<span style="color:#333">.</span>ManyToManyField(Intern, blank<span style="color:#333">=</span>True)

    <span style="color:#555;font-weight:bold">@property</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">people</span>(self):
        <span style="color:#080;font-weight:bold">return</span> self<span style="color:#333">.</span>managers<span style="color:#333">.</span><span style="color:#007020">all</span>() <span style="color:#333">|</span> self<span style="color:#333">.</span>employees<span style="color:#333">.</span><span style="color:#007020">all</span>() <span style="color:#333">|</span> self<span style="color:#333">.</span>interns<span style="color:#333">.</span><span style="color:#007020">all</span>()</code></pre></div>
<p>I want to test that this model property method indeed returns all the objects from those 3 ManyToMany fields. We will write a unit test that does so.</p>

<h4 id="factories">Factories</h4>

<p>Before we begin writing the test, let&rsquo;s understand what factories are and how they can help us write better tests.</p>

<p>Factories are defined objects that represent a model in our application. Factories can help us generate an infinite amount of test data and instances that our tests can use.</p>

<p>From the <code>Bank</code> model example above, I can go ahead and make a factory for this model. I usually put my factories in a <code>/tests/factories.py</code> module:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">factory</span>

<span style="color:#080;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">myapp.models</span> <span style="color:#080;font-weight:bold">import</span> Bank


<span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">BankFactory</span>(factory<span style="color:#333">.</span>django<span style="color:#333">.</span>DjangoModelFactory):
    <span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">Meta</span>:
        model <span style="color:#333">=</span> Bank

    name <span style="color:#333">=</span> factory<span style="color:#333">.</span>Sequence(<span style="color:#080;font-weight:bold">lambda</span> n: <span style="background-color:#fff0f0">&#39;bank_</span><span style="background-color:#eee">%d</span><span style="background-color:#fff0f0">&#39;</span> <span style="color:#333">%</span> n)

    <span style="color:#555;font-weight:bold">@factory.post_generation</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">managers</span>(self, create, extracted, <span style="color:#333">**</span>kwargs):
        <span style="color:#080;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">not</span> create:
            <span style="color:#080;font-weight:bold">return</span>

        <span style="color:#080;font-weight:bold">if</span> extracted:
            <span style="color:#080;font-weight:bold">for</span> manager <span style="color:#000;font-weight:bold">in</span> extracted:
                self<span style="color:#333">.</span>managers<span style="color:#333">.</span>add(manager)

    <span style="color:#888"># Same for interns and employees</span>
    <span style="color:#888"># ...</span></code></pre></div>
<p>The <code>@factory.post_generation</code> allows us to add more objects to the ManyToMany relation. Assuming we also have factories for those models, we could create a test bank object like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">bank <span style="color:#333">=</span> BankFactory(
    managers<span style="color:#333">=</span>[ManagerFactory()],
    employees<span style="color:#333">=</span>[EmployeeFactory()],
    interns<span style="color:#333">=</span>[InternFactory()]
)</code></pre></div>
<p>And now we can finally use that in our test:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888"># tests/unit/test_banks.py</span>

<span style="color:#080;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">pytest</span>

<span style="color:#080;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">myapp.tests.factories</span> <span style="color:#080;font-weight:bold">import</span> (
    BankFactory,
    ManagerFactory,
    EmployeeFactory,
    InternFactory
)


<span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">TestBanks</span>:

    <span style="color:#555;font-weight:bold">@pytest.mark.django_db</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">test_bank_people</span>(self):
        <span style="background-color:#fff0f0">&#34;&#34;&#34;Tests that we can obtain all people associated with this bank.&#34;&#34;&#34;</span>
        bank <span style="color:#333">=</span> BankFactory(
            managers<span style="color:#333">=</span>[ManagerFactory()],
            employees<span style="color:#333">=</span>[EmployeeFactory()],
            interns<span style="color:#333">=</span>[InternFactory()]
        )

      <span style="color:#080;font-weight:bold">assert</span> bank<span style="color:#333">.</span>people<span style="color:#333">.</span>count() <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">3</span></code></pre></div>
<p>Since we are creating 3 people of different type each in our test, this test should pass.</p>

<p>-&gt; <code>@pytest.mark.django_db</code> is a decorator provided by pytest-django that gives the test write access to the database.</p>

<h3 id="view-tests">View Tests</h3>

<p>Now let&rsquo;s take a look at how we can test our views. I will show an example of a <strong>Class Based View</strong>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">django.http</span> <span style="color:#080;font-weight:bold">import</span> JsonResponse
<span style="color:#080;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">django.views</span> <span style="color:#080;font-weight:bold">import</span> View


<span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyView</span>(View):

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">get</span>(self, request):
        <span style="color:#888"># Some complex processing here.</span>

        <span style="color:#080;font-weight:bold">return</span> JsonResponse({<span style="background-color:#fff0f0">&#39;result&#39;</span>: <span style="background-color:#fff0f0">&#39;FINISHED&#39;</span>})</code></pre></div>
<p>And it&rsquo;s URL:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">url(<span style="background-color:#fff0f0">r</span><span style="background-color:#fff0f0">&#39;^(?i)myview/$&#39;</span>, views<span style="color:#333">.</span>MyView<span style="color:#333">.</span>as_view(), name<span style="color:#333">=</span><span style="background-color:#fff0f0">&#39;myview&#39;</span>),</code></pre></div>
<p>A very simple view. We are going to test 2 things:</p>

<ol>
<li>The response status code</li>
<li>The response content</li>
</ol>

<p>Of course, depending on the complexity of your view you can (and should) test more things, like objects created/remove in the database, etc. etc.</p>

<p>To test this view we will be using the <code>rf</code> request factory pytest fixture provided by pytest-django. We only need to add it to the test function&rsquo;s parameters:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888"># tests/integration/test_myview.py</span>

<span style="color:#080;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">json</span>

<span style="color:#080;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">django.core.urlresolvers</span> <span style="color:#080;font-weight:bold">import</span> reverse

<span style="color:#080;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">myapp.views</span> <span style="color:#080;font-weight:bold">import</span> MyView


<span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">TestMyView</span>:

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">test_result_finished</span>(self, rf):
        request <span style="color:#333">=</span> rf<span style="color:#333">.</span>get(reverse(<span style="background-color:#fff0f0">&#39;myview&#39;</span>))
        response <span style="color:#333">=</span> MyView<span style="color:#333">.</span>as_view()(request)

        <span style="color:#080;font-weight:bold">assert</span> response<span style="color:#333">.</span>status_code <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">200</span>

        content <span style="color:#333">=</span> json<span style="color:#333">.</span>loads(response<span style="color:#333">.</span>content)
        <span style="color:#080;font-weight:bold">assert</span> content[<span style="background-color:#fff0f0">&#39;result&#39;</span>] <span style="color:#333">==</span> <span style="background-color:#fff0f0">&#39;FINISHED&#39;</span></code></pre></div>
<p>And that&rsquo;s it. Keep in mind that this view is not interacting with the database, so I did not include the decorator we saw before. Also, we are not taking into account any authentication in this view. If you need to, then you can assign a user to the <code>request</code> object:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">request<span style="color:#333">.</span>user <span style="color:#333">=</span> my_user</code></pre></div>
<p>In this case <code>my_user</code> can be a user generated by a factory (if you have custom user auth models in your application), or you can use another user fixture provided by pytest-django.</p>

<h4 id="testing-view-context-data">Testing View Context Data</h4>

<p>If you ever need to test the view&rsquo;s context data you can do so by accessing <code>response.context_data</code> dictionary. However if you are like me and prefer setting a CBV&rsquo;s context data using <a href="https://reinout.vanrees.org/weblog/2014/05/19/context.html">this method</a> (just to show an example):</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyView</span>(TemplateView):
    template_name <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#39;mytemplate.html&#39;</span>

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">books</span>(self):
        <span style="color:#080;font-weight:bold">return</span> Book<span style="color:#333">.</span>objects<span style="color:#333">.</span><span style="color:#007020">filter</span>(library__name<span style="color:#333">=</span>self<span style="color:#333">.</span>request<span style="color:#333">.</span>kwargs[<span style="background-color:#fff0f0">&#39;library_name&#39;</span>])</code></pre></div>
<p>You can make the assertion by accessing the <code>view</code> object in the dictionary, just like it is done in the template. Like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">assert</span> <span style="color:#007020">len</span>(response<span style="color:#333">.</span>context_data[<span style="background-color:#fff0f0">&#39;view&#39;</span>]<span style="color:#333">.</span>titulos()) <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">2</span></code></pre></div>
<h4 id="setting-cookies">Setting Cookies</h4>

<p>If you need to set special cookies in your tests to test a view. You can do it using a request factory easily :</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">request<span style="color:#333">.</span>COOKIES[<span style="background-color:#fff0f0">&#39;mycookie&#39;</span>] <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#39;akdasd090190239091290013asd;&#39;</span></code></pre></div>
<h2 id="testing-django-rest-framework">Testing Django REST Framework</h2>

<p>Testing DRF is very similar to testing Django views. However, DRF&rsquo;s views extend Django&rsquo;s class based views and therefore are more complex. Additionally, DRF comes with its own set of test <a href="http://www.django-rest-framework.org/api-guide/testing/">classes and utilities</a> that we can use to make the process easier.</p>

<p>The <code>APITestCase</code> class is a very neat class to use for DRF tests, it comes with its own instance of <code>APIClient</code>. However, since <code>APITestCase</code> subclasses Django&rsquo;s <code>TestCase</code> class, we won&rsquo;t be able to pass Pytest fixtures to our tests. This means that we will have to force authenticate the client and assign it a user in <em>each</em> of the tests. Very cumbersome.</p>

<p>This is why I prefer not using <code>APITestCase</code> and create a custom fixture that returns a <code>APIClient</code> instead. We&rsquo;ll see how this works in the next section.</p>

<h3 id="testing-viewsets">Testing Viewsets</h3>

<p><a href="http://www.django-rest-framework.org/api-guide/viewsets/">DRF Viewsets</a> are extremely handy. Unfortunately the documentation to test them is not very straightforward.</p>

<p>Since Viewsets can handle the usual REST requests (GET, POST, PUT, PATCH, DELETE) in a single viewset class, it is necessary that we understand how to specify which action we want to target in our tests.</p>

<p>For these examples I am going to use the following viewset:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">rest_framework</span> <span style="color:#080;font-weight:bold">import</span> viewsets


<span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">BankViewSet</span>(viewsets<span style="color:#333">.</span>ModelViewSet):
    queryset <span style="color:#333">=</span> Bank<span style="color:#333">.</span>objects<span style="color:#333">.</span><span style="color:#007020">all</span>()
    serializer_class <span style="color:#333">=</span> BankSerializer</code></pre></div>
<h4 id="get">GET</h4>

<p>Like I mentioned previously, we will use a custom fixture that returns an <code>APIClient</code> object. We can assign a user and force authentication in the fixture.</p>

<h2 id="references">References</h2>
</div>


<div style="margin: 20px 0px;">
  
    <a href="http://aalvarez.me/tags/python" class="label label-default">python</a></li>
  
    <a href="http://aalvarez.me/tags/django" class="label label-default">django</a></li>
  
    <a href="http://aalvarez.me/tags/djangorestframework" class="label label-default">djangorestframework</a></li>
  
</div>


<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "aalvarez-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>

    
  </body>
</html>
