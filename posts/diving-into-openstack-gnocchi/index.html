<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.52" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Diving Into OpenStack Gnocchi &middot; Andrés Álvarez</title>

  
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/hyde.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/extra.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/overrides.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Andrés Álvarez" />

  
</head>

  <body class="theme-base-08 ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://aalvarez.me/"><h1>Andrés Álvarez</h1></a>
      <p class="lead">
       Software Engineer &amp; Web Developer 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="http://aalvarez.me/">Home</a> </li>
        <li><a href="/tags/">Tags</a></li>
        <li><a href="/about/"> About Me </a></li><li><a href="/portfolio/"> Portfolio </a></li>
      </ul>
    </nav>

    
    <ul id="social-media" class="list-inline">
      
        <li>
           <a href="mailto:andresalvarez353@gmail.com" target="_blank"><i class="fa fa-envelope fa-2x" title="E-Mail"></i></a>
        </li>
      

      
        <li>
          <a href="https://linkedin.com/in/aalvarez4" target="_blank"><i class="fa fa-linkedin fa-2x" title="LinkedIn"></i></a>
        </li>
      

      
        <li>
          <a href="https://github.com/BigChief45" target="_blank"><i class="fa fa-github fa-2x" title="Github"></i></a>
        </li>
      

      
        <li>
          <a href="https://www.instagram.com/aalvarez300" target="_blank"><i class="fa fa-instagram fa-2x" title="Instagram"></i></a>
        </li>
      

      
        <li>
          <a href="/feed.xml" target="_blank"><i class="fa fa-rss fa-2x" title="RSS"></i></a>
        </li>
      
    </ul>

    <p>&copy; 2018. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Diving Into OpenStack Gnocchi</h1>
  <time datetime=2017-04-25T00:00:00Z class="post-date">Tue, Apr 25, 2017</time>

  <p>Gnocchi is a multi-tenant timeseries, metrics and resources database. It provides an HTTP REST interface to create and manipulate the data. It is designed to store metrics at a very large scale while providing access to metrics and resources information and history.</p>

<p>It is the preferred storage method for metrics in Ceilometer, as of OpenStack Ocata.</p>

<p>In this post I want to dive into Gnocchi specifics such as its configuration, supported backends, APIs, daemons, and source code.</p>

<h2 id="configuration">Configuration</h2>

<p>Gnocchi&rsquo;s configuration is stored in a file called <code>gnocchi.conf</code>. Ideally, this file would be in <code>~/gnocchi.conf</code> or <code>/etc/gnocchi/gnocchi.conf</code>. Let&rsquo;s take a look at a basic Gnocchi configuration:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#080;font-weight:bold">[DEFAULT]</span>
<span style="color:#00c">debug</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">true</span>
<span style="color:#00c">verbose</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">true</span>

<span style="color:#080;font-weight:bold">[api]</span>
<span style="color:#00c">workers</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">1</span>

<span style="color:#080;font-weight:bold">[database]</span>
<span style="color:#00c">backend</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">sqlalchemy</span>

<span style="color:#080;font-weight:bold">[indexer]</span>
<span style="color:#00c">url</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">postgresql://gnocchi:gnocchi@127.0.0.1/gnocchi</span>

<span style="color:#080;font-weight:bold">[storage]</span>
<span style="color:#00c">coordination_url</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">file:///home/ubuntu/gn/locks</span>
<span style="color:#00c">driver</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">file</span>
<span style="color:#00c">file_basepath</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">/home/ubuntu/gn</span>

<span style="color:#080;font-weight:bold">[cors]</span>
<span style="color:#00c">allowed_origin</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">*</span>
<span style="color:#00c">allow_credentials</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">false</span></code></pre></div>
<p>The configuration above sets up Gnocchi to use Postgresql as the indexer, and use the file system for storage. Additionally it sets up CORS so that requests from any origin are allowed. You will want to configure CORS in a more secure manner when deploying to a production environment.</p>

<h3 id="database-setup">Database Setup</h3>

<p>For this example, we are going to use <a href="www.c9.io">Cloud 9</a> as our environment, and Postgresql as the database. This means that we need to first setup the database before we start using Gnocchi.</p>

<p>Make sure the Postgresql service is running:</p>

<pre><code>sudo service postgresql start
</code></pre>

<p>We can enter the Postgresql command line using:</p>

<pre><code>sudo sudo -u postgres psql
</code></pre>

<p>Now let&rsquo;s create a new Postgresql user:</p>

<pre><code>CREATE USER gnocchi SUPERUSER PASSWORD 'gnocchi';
</code></pre>

<p>Then create the database:</p>

<pre><code>CREATE DATABASE gnocchi WITH TEMPLATE = template0 ENCODING = 'UNICODE';
</code></pre>

<p>When the database is finally set up correctly and the configuration file is in place, we can initialize the indexer and storage:</p>

<pre><code>gnocchi-upgrade
</code></pre>

<p>You should see the following output logs:</p>

<pre><code>2017-05-17 05:28:50.917 3895 INFO gnocchi.cli [-] Upgrading indexer &lt;gnocchi.indexer.sqlalchemy.SQLAlchemyIndexer object at 0x7ff76cff6190&gt;
2017-05-17 05:28:50.982 3895 INFO alembic.runtime.migration [-] Context impl PostgresqlImpl.
2017-05-17 05:28:50.982 3895 INFO alembic.runtime.migration [-] Will assume transactional DDL.
2017-05-17 05:28:51.011 3895 INFO alembic.runtime.migration [-] Context impl PostgresqlImpl.
2017-05-17 05:28:51.011 3895 INFO alembic.runtime.migration [-] Will assume transactional DDL.
2017-05-17 05:28:51.154 3895 INFO gnocchi.cli [-] Upgrading storage &lt;gnocchi.storage.file.FileStorage object at 0x7ff7688f9710&gt;
</code></pre>

<h2 id="gnocchi-rest-api">Gnocchi REST API</h2>

<p>Gnocchi&rsquo;s REST API is based on <a href="http://www.pecanpy.org/index.html">Pecan</a>, a very lightweight Python web framework that provides object-dispatch style routing. We can confirm this in Gnocchi&rsquo;s <code>rest/__init__.py</code> file:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">pecan</span>
<span style="color:#080;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">pecan</span> <span style="color:#080;font-weight:bold">import</span> rest</code></pre></div>
<h3 id="metrics">Metrics</h3>

<p>Gnocchi provides an object type that is called metric. A metric designates any thing that can be measured: the CPU usage of a server, the temperature of a room or the number of bytes sent by a network interface.</p>

<p>A metric only has a few properties: a UUID to identify it, a name, the archive policy that will be used to store and aggregate the measures.</p>

<p>Farther down the code in <code>rest/__init__.py</code>, we can find a metric controller which inherits from a Pecan REST controller:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MetricController</span>(rest<span style="color:#333">.</span>RestController):
    _custom_actions <span style="color:#333">=</span> {
        <span style="background-color:#fff0f0">&#39;measures&#39;</span>: [<span style="background-color:#fff0f0">&#39;POST&#39;</span>, <span style="background-color:#fff0f0">&#39;GET&#39;</span>]
    }

    <span style="color:#080;font-weight:bold">def</span> __init__(self, metric):
        self<span style="color:#333">.</span>metric <span style="color:#333">=</span> metric
        mgr <span style="color:#333">=</span> extension<span style="color:#333">.</span>ExtensionManager(namespace<span style="color:#333">=</span><span style="background-color:#fff0f0">&#39;gnocchi.aggregates&#39;</span>,
                                         invoke_on_load<span style="color:#333">=</span>True)
        self<span style="color:#333">.</span>custom_agg <span style="color:#333">=</span> <span style="color:#007020">dict</span>((x<span style="color:#333">.</span>name, x<span style="color:#333">.</span>obj) <span style="color:#080;font-weight:bold">for</span> x <span style="color:#000;font-weight:bold">in</span> mgr)

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">enforce_metric</span>(self, rule):
        enforce(rule, json<span style="color:#333">.</span>to_primitive(self<span style="color:#333">.</span>metric))

    <span style="color:#555;font-weight:bold">@pecan.expose</span>(<span style="background-color:#fff0f0">&#39;json&#39;</span>)
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">get_all</span>(self):
        self<span style="color:#333">.</span>enforce_metric(<span style="background-color:#fff0f0">&#34;get metric&#34;</span>)
        <span style="color:#080;font-weight:bold">return</span> self<span style="color:#333">.</span>metric</code></pre></div>
<p>From the <a href="http://pecan.readthedocs.io/en/latest/routing.html">Pecan documentation</a>, we can learn that Pecan uses a routing strategy known as object-dispatch to map an HTTP request to a controller, and then the method to call. Object-dispatch begins by splitting the path into a list of components and then walking an object path, starting at the root controller.</p>

<p>We can tell Pecan which methods in a class are publically-visible via <code>expose()</code>. If a method is not decorated with <code>expose()</code>, Pecan will never route a request to it. In the example above, the <code>get_all()</code> method is exposed to Pecan. Additionally, it makes use of Pecan&rsquo;s built-in support for a special JSON renderer, which translates template namespaces into rendered JSON text. Meaning that the returned content will be rendered as JSON.</p>

<p>However, we specifically want to how Pecan&rsquo;s <a href="http://pecan.readthedocs.io/en/latest/rest.html#writing-restful-web-services-with-restcontroller">Rest Controllers work</a>. By default, Rest controllers routes as follows:</p>

<table>
<thead>
<tr>
<th align="center">Method</th>
<th align="center">Description</th>
<th align="center">Example Method(s) / URL(s)</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">get_one</td>
<td align="center">Display one record</td>
<td align="center"><code>GET /books/1</code></td>
</tr>

<tr>
<td align="center">get_all</td>
<td align="center">Display all records in a resource</td>
<td align="center"><code>GET /books/</code></td>
</tr>

<tr>
<td align="center">get</td>
<td align="center">A combo of get_one and get_all</td>
<td align="center"><code>GET /books/</code> <code>GET /books/1</code></td>
</tr>

<tr>
<td align="center">new</td>
<td align="center">Display a page to create a new resource</td>
<td align="center"><code>GET /books/new</code></td>
</tr>

<tr>
<td align="center">edit</td>
<td align="center">Display a page to edit an existing resource</td>
<td align="center"><code>GET /books/1/edit</code></td>
</tr>

<tr>
<td align="center">post</td>
<td align="center">Create a new record</td>
<td align="center"><code>POST /books/</code></td>
</tr>

<tr>
<td align="center">put</td>
<td align="center">Update an existing record</td>
<td align="center"><code>POST /books/1?_method=put</code> <code>PUT /books/1</code></td>
</tr>

<tr>
<td align="center">get_delete</td>
<td align="center">Display a delete confirmation page</td>
<td align="center"><code>GET /books/1/delete</code></td>
</tr>

<tr>
<td align="center">delete</td>
<td align="center">Delete an existing record</td>
<td align="center"><code>POST /books/1?_method=delete</code> <code>DELETE /books/1</code></td>
</tr>
</tbody>
</table>

<h3 id="authentication">Authentication</h3>

<p>By default, the authentication is configured to basic mode. You need to provide an authorization header in your HTTP requests with a valid username (the password is not used). The <code>admin</code> password is granted all privileges, whereas any other username is recognize as having standard permissions.</p>

<p>Other modes of authentication are: no authentication, and Keystone authentication.</p>

<p>Gnocchi handles authentication using a helper for each type of authentication. These helpers can be found in <code>rest/auth_helper.py</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">BasicAuthHelper</span>(<span style="color:#007020">object</span>):
    <span style="color:#555;font-weight:bold">@staticmethod</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">get_current_user</span>(headers):
        auth <span style="color:#333">=</span> werkzeug<span style="color:#333">.</span>http<span style="color:#333">.</span>parse_authorization_header(
            headers<span style="color:#333">.</span>get(<span style="background-color:#fff0f0">&#34;Authorization&#34;</span>))
        <span style="color:#080;font-weight:bold">if</span> auth <span style="color:#000;font-weight:bold">is</span> None:
            rest<span style="color:#333">.</span>abort(<span style="color:#00d;font-weight:bold">401</span>)
        <span style="color:#080;font-weight:bold">return</span> auth<span style="color:#333">.</span>username

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">get_auth_info</span>(self, headers):
        user <span style="color:#333">=</span> self<span style="color:#333">.</span>get_current_user(headers)
        roles <span style="color:#333">=</span> []
        <span style="color:#080;font-weight:bold">if</span> user <span style="color:#333">==</span> <span style="background-color:#fff0f0">&#34;admin&#34;</span>:
            roles<span style="color:#333">.</span>append(<span style="background-color:#fff0f0">&#34;admin&#34;</span>)
        <span style="color:#080;font-weight:bold">return</span> {
            <span style="background-color:#fff0f0">&#34;user&#34;</span>: user,
            <span style="background-color:#fff0f0">&#34;roles&#34;</span>: roles
        }

    <span style="color:#555;font-weight:bold">@staticmethod</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">get_resource_policy_filter</span>(headers, rule, resource_type):
        <span style="color:#080;font-weight:bold">return</span> None</code></pre></div>
<p>It is important to mention that basic authentication is made possible because of <a href="http://werkzeug.pocoo.org/">Werkzeug</a>, Werkzeug is a <a href="https://en.wikipedia.org/wiki/Web_Server_Gateway_Interface">WSGI</a> utility library for Python. In the basic auth helper, Werkzeug helps parsing the HTTP headers.</p>

<h2 id="storage">Storage</h2>

<p>Gnocchi offers different storage drivers such as Redis, File, OpenStack Swift, and Amazon S3. However the preffered driver is <a href="http://ceph.com/">Ceph</a>. In simple words, Ceph is a tool that provides applications with <strong>object</strong>, <strong>block</strong>, and <strong>file system</strong> storage in a single unified storage cluster.</p>

<p>Additionally, an intermediary library inside Gnocchi called Carbonara is in charge of the time series manipulation.</p>

<p>Storage logic can be found in <a href="https://github.com/openstack/gnocchi/blob/master/gnocchi/storage/"><code>gnocchi/storage</code></a>. Some basic classes defining drivers, measures, and metrics can be found in the <code>__init__.py</code> file:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">Metric</span>(<span style="color:#007020">object</span>):
    <span style="color:#080;font-weight:bold">def</span> __init__(self, <span style="color:#007020">id</span>, archive_policy,
                 creator<span style="color:#333">=</span>None,
                 name<span style="color:#333">=</span>None,
                 resource_id<span style="color:#333">=</span>None):
        self<span style="color:#333">.</span><span style="color:#007020">id</span> <span style="color:#333">=</span> <span style="color:#007020">id</span>
        self<span style="color:#333">.</span>archive_policy <span style="color:#333">=</span> archive_policy
        self<span style="color:#333">.</span>creator <span style="color:#333">=</span> creator
        self<span style="color:#333">.</span>name <span style="color:#333">=</span> name
        self<span style="color:#333">.</span>resource_id <span style="color:#333">=</span> resource_id

    <span style="color:#080;font-weight:bold">def</span> __repr__(self):
        <span style="color:#080;font-weight:bold">return</span> <span style="background-color:#fff0f0">&#39;&lt;</span><span style="background-color:#eee">%s</span><span style="background-color:#fff0f0"> </span><span style="background-color:#eee">%s</span><span style="background-color:#fff0f0">&gt;&#39;</span> <span style="color:#333">%</span> (self<span style="color:#333">.</span>__class__<span style="color:#333">.</span>__name__, self<span style="color:#333">.</span><span style="color:#007020">id</span>)</code></pre></div>
<p>We can find the storage logic for Ceph in <code>ceph.py</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">CephStorage</span>(_carbonara<span style="color:#333">.</span>CarbonaraBasedStorage):
    WRITE_FULL <span style="color:#333">=</span> False

    <span style="color:#080;font-weight:bold">def</span> __init__(self, conf, incoming):
        <span style="color:#007020">super</span>(CephStorage, self)<span style="color:#333">.</span>__init__(conf, incoming)
        self<span style="color:#333">.</span>rados, self<span style="color:#333">.</span>ioctx <span style="color:#333">=</span> ceph<span style="color:#333">.</span>create_rados_connection(conf)

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">stop</span>(self):
        ceph<span style="color:#333">.</span>close_rados_connection(self<span style="color:#333">.</span>rados, self<span style="color:#333">.</span>ioctx)
        <span style="color:#007020">super</span>(CephStorage, self)<span style="color:#333">.</span>stop()

    <span style="color:#555;font-weight:bold">@staticmethod</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">_get_object_name</span>(metric, timestamp_key, aggregation, granularity,
                         version<span style="color:#333">=</span><span style="color:#00d;font-weight:bold">3</span>):
        name <span style="color:#333">=</span> <span style="color:#007020">str</span>(<span style="background-color:#fff0f0">&#34;gnocchi_</span><span style="background-color:#eee">%s</span><span style="background-color:#fff0f0">_</span><span style="background-color:#eee">%s</span><span style="background-color:#fff0f0">_</span><span style="background-color:#eee">%s</span><span style="background-color:#fff0f0">_</span><span style="background-color:#eee">%s</span><span style="background-color:#fff0f0">&#34;</span> <span style="color:#333">%</span> (
            metric<span style="color:#333">.</span><span style="color:#007020">id</span>, timestamp_key, aggregation, granularity))
        <span style="color:#080;font-weight:bold">return</span> name <span style="color:#333">+</span> <span style="background-color:#fff0f0">&#39;_v</span><span style="background-color:#eee">%s</span><span style="background-color:#fff0f0">&#39;</span> <span style="color:#333">%</span> version <span style="color:#080;font-weight:bold">if</span> version <span style="color:#080;font-weight:bold">else</span> name

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">_object_exists</span>(self, name):
        <span style="color:#080;font-weight:bold">try</span>:
            self<span style="color:#333">.</span>ioctx<span style="color:#333">.</span>stat(name)
            <span style="color:#080;font-weight:bold">return</span> True
        <span style="color:#080;font-weight:bold">except</span> rados<span style="color:#333">.</span>ObjectNotFound:
            <span style="color:#080;font-weight:bold">return</span> False

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">_create_metric</span>(self, metric):
        name <span style="color:#333">=</span> self<span style="color:#333">.</span>_build_unaggregated_timeserie_path(metric, <span style="color:#00d;font-weight:bold">3</span>)
        <span style="color:#080;font-weight:bold">if</span> self<span style="color:#333">.</span>_object_exists(name):
            <span style="color:#080;font-weight:bold">raise</span> storage<span style="color:#333">.</span>MetricAlreadyExists(metric)
        <span style="color:#080;font-weight:bold">else</span>:
            self<span style="color:#333">.</span>ioctx<span style="color:#333">.</span>write_full(name, <span style="background-color:#fff0f0">b</span><span style="background-color:#fff0f0">&#34;&#34;</span>)</code></pre></div>
<h2 id="gnocchi-tests">Gnocchi Tests</h2>

<p>Running the tests in Gnocchi took me a while. Mainly because I am not very familiar with testing in Python and how testing with OpenStack libraries work.</p>

<p>Tests are run using <strong>tox</strong> and <a href="https://wiki.openstack.org/wiki/Testr"><strong>testr</strong></a>. Therefore we first install tox using pip inside the virtual environment. In Gnocchi (and each OpenStack project) there will be a <code>tox.ini</code> file in the root directory. This is a set of test configurations for the project. For example, we can see a list of available environments to test against:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#080;font-weight:bold">[tox]</span>
<span style="color:#00c">minversion</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">2.4</span>
<span style="color:#00c">envlist</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">py{35,27}-{postgresql,mysql}{,-file,-swift,-ceph,-s3},pep8,bashate</span></code></pre></div>
<p>The complete list can be shown by using the <code>tox -l</code> command.</p>

<p>The default settings that applies to all environments are located underneath the <code>[testenv]</code> directive:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#080;font-weight:bold">[testenv]</span>
<span style="color:#00c">usedevelop</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">True</span>
<span style="color:#00c">sitepackages</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">False</span>
<span style="color:#00c">passenv</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">LANG OS_DEBUG OS_TEST_TIMEOUT OS_STDOUT_CAPTURE OS_STDERR_CAPTURE OS_LOG_CAPTURE GNOCCHI_TEST_* AWS_*</span>
<span style="color:#00c">setenv</span> <span style="color:#333">=</span><span style="background-color:#fff0f0">
</span><span style="background-color:#fff0f0">    GNOCCHI_TEST_STORAGE_DRIVER=file
</span><span style="background-color:#fff0f0">    GNOCCHI_TEST_INDEXER_DRIVER=postgresql</span>

<span style="color:#888"># ...</span></code></pre></div>
<p>Specific environment configurations are specified by adding a a directive with the environment name after the colon:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#080;font-weight:bold">[testenv:py35-postgresql-file-upgrade-from-3.1]</span></code></pre></div>
<p>So to summarize all this, it all basically means that we can run tests with tox using one of these environments, like this:</p>

<pre><code>tox -e py27-postgresql-file
</code></pre>

<p>This will create a directory for this environment under a hidden <code>.tox/</code> directory in the project and will begin installing dependencies. Since tox itself creates a virtual environment using <code>virtualenv</code>, <strong>you must make sure that you have an up to date version of virtualenv installed</strong>.</p>

<p>-&gt; Why does tox take so long to run? The reason tox takes a long time is two-fold: On the first run it has to create a virtual environment, which can take anywhere from 5 to 30+ minutes depending on the project and the system. The other reason is that it just takes a long time to run all of the test cases in some of the projects.</p>

<h2 id="references">References</h2>

<ol>
<li><a href="http://gnocchi.xyz/index.html">Gnocchi official documentation</a></li>
<li><a href="http://amalagon.github.io/blog/2014/09/14/miscellaneous-on-gnocchi/"><em>Miscellaneous Resources on Gnocchi</em></a></li>
<li><a href="http://pecan.readthedocs.io/en/latest/deployment.html">Deploying Pecan in Production</a></li>
<li><a href="https://wiki.openstack.org/wiki/Testr">https://wiki.openstack.org/wiki/Testr</a></li>
<li><a href="https://wiki.openstack.org/wiki/Testing">https://wiki.openstack.org/wiki/Testing</a></li>
<li><a href="http://waprin.io/2015/05/21/introducing-tox.html">http://waprin.io/2015/05/21/introducing-tox.html</a></li>
</ol>
</div>


<div style="margin: 20px 0px;">
  
    <a href="http://aalvarez.me/tags/gnocchi" class="label label-default">gnocchi</a></li>
  
    <a href="http://aalvarez.me/tags/ceilometer" class="label label-default">ceilometer</a></li>
  
    <a href="http://aalvarez.me/tags/openstack" class="label label-default">openstack</a></li>
  
    <a href="http://aalvarez.me/tags/python" class="label label-default">python</a></li>
  
    <a href="http://aalvarez.me/tags/ceph" class="label label-default">ceph</a></li>
  
    <a href="http://aalvarez.me/tags/pecan" class="label label-default">pecan</a></li>
  
</div>


<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "aalvarez-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>

    
  </body>
</html>
