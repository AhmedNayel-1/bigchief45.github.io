<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.52" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Extending Device Python Classes From Other ZenPacks &middot; Andrés Álvarez</title>

  
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/hyde.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/extra.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/overrides.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Andrés Álvarez" />

  
</head>

  <body class="theme-base-08 ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://aalvarez.me/"><h1>Andrés Álvarez</h1></a>
      <p class="lead">
       Software Engineer &amp; Web Developer 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="http://aalvarez.me/">Home</a> </li>
        <li><a href="/tags/">Tags</a></li>
        <li><a href="/about/"> About Me </a></li><li><a href="/portfolio/"> Portfolio </a></li>
      </ul>
    </nav>

    
    <ul id="social-media" class="list-inline">
      
        <li>
           <a href="mailto:andresalvarez353@gmail.com" target="_blank"><i class="fa fa-envelope fa-2x" title="E-Mail"></i></a>
        </li>
      

      
        <li>
          <a href="https://linkedin.com/in/aalvarez4" target="_blank"><i class="fa fa-linkedin fa-2x" title="LinkedIn"></i></a>
        </li>
      

      
        <li>
          <a href="https://github.com/BigChief45" target="_blank"><i class="fa fa-github fa-2x" title="Github"></i></a>
        </li>
      

      
        <li>
          <a href="https://www.instagram.com/aalvarez300" target="_blank"><i class="fa fa-instagram fa-2x" title="Instagram"></i></a>
        </li>
      

      
        <li>
          <a href="/feed.xml" target="_blank"><i class="fa fa-rss fa-2x" title="RSS"></i></a>
        </li>
      
    </ul>

    <p>&copy; 2018. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Extending Device Python Classes From Other ZenPacks</h1>
  <time datetime=2017-06-27T00:00:00Z class="post-date">Tue, Jun 27, 2017</time>

  <p>Recently I was struggling with trying to make two custom ZenPacks work together with device objects in the Zenoss database. My issue was that a main ZenPack (which would be installed first) would create a custom class that inherits from <code>Device</code>. This ZenPack would add a lot of properties and relationships with custom components. Then, a second optional ZenPack could be installed which would extend this same class with an additional property that would work along with a <a href="/posts/working-with-zenoss-python-data-sources.html">Python data source</a>.</p>

<p>The <code>zenpack.yaml</code> file for the first and main ZenPack would look something like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#888"># ZenPack1</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>classes:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>SpecialServer:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>base:<span style="color:#bbb"> </span>[zenpacklib.Device]<span style="color:#bbb">
</span><span style="color:#bbb">    </span>label:<span style="color:#bbb"> </span>Special<span style="color:#bbb"> </span>Server<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>SpecialComponent:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>base:<span style="color:#bbb"> </span>[zenpacklib.Component]<span style="color:#bbb">
</span><span style="color:#bbb">    </span>label:<span style="color:#bbb"> </span>Special<span style="color:#bbb"> </span>Component<span style="color:#bbb">
</span><span style="color:#bbb">    </span>properties:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#888"># ...</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>AmazingComponent:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>base:<span style="color:#bbb"> </span>[zenpacklib.Component]<span style="color:#bbb">
</span><span style="color:#bbb">    </span>label:<span style="color:#bbb"> </span>Amazing<span style="color:#bbb"> </span>Component<span style="color:#bbb">
</span><span style="color:#bbb">    </span>properties:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#888"># ...</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>class_relationships:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>SpecialServer<span style="color:#bbb"> </span><span style="color:#60e;font-weight:bold">1</span>:MC<span style="color:#bbb"> </span>SpecialComponent<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>SpecialServer<span style="color:#bbb"> </span><span style="color:#60e;font-weight:bold">1</span>:MC<span style="color:#bbb"> </span>AmazingComponent</code></pre></div>
<p>So what I wanted was to somehow be able to extend this <code>SpecialServer</code> class and add a new property to it, all of this done from the <strong>second</strong> ZenPack. Initially I tried doing this using ZenPackLib, doing something along the lines of:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#888"># ZenPack2</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>classes:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>ZenPacks.aalvarez.ZenPack1.SpecialServer.SpecialServer:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>properties:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>my_new_property:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>type:<span style="color:#bbb"> </span>boolean<span style="color:#bbb">
</span><span style="color:#bbb">        </span>default:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">false</span></code></pre></div>
<p>Hoping that zenpacklib would somehow be smart enough to just append this additional attribute. The above however did not work.</p>

<h2 id="zenpack-monkey-patching">ZenPack Monkey Patching</h2>

<p>It turns out that the way to do this is to perform some <a href="https://en.wikipedia.org/wiki/Monkey_patch">monkey patching</a> from the ZenPack. Monkey patching is the dynamic replacement of attributes at runtime.</p>

<p>When developing ZenPacks that perform monkey patching, there are some <a href="http://zenpackers.readthedocs.io/en/latest/monkeypatching.html">guidelines</a> that can be followed for more organized code.</p>

<h3 id="zenpack-patches-directory">ZenPack Patches Directory</h3>

<p>First we must create a directory called <code>patches</code> in the ZenPack&rsquo;s main directory (where <code>zenpack.yaml</code> resides). Inside the <code>patches</code> directory, we will place a Python init file that will take the responsibility of validating that everything that will be monkey patched can be correctly imported when the ZenPack is installed:</p>

<p><strong>patches/<strong>init</strong>.py</strong>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">logging</span>
<span style="color:#080;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">importlib</span> <span style="color:#080;font-weight:bold">import</span> import_module

log <span style="color:#333">=</span> logging<span style="color:#333">.</span>getLogger(<span style="background-color:#fff0f0">&#39;zen.ZenPack2&#39;</span>)


<span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">optional_import</span>(module_name, patch_module_name):
    <span style="color:#080;font-weight:bold">try</span>:
        import_module(module_name)
    <span style="color:#080;font-weight:bold">except</span> <span style="color:#f00;font-weight:bold">ImportError</span>:
        <span style="color:#080;font-weight:bold">pass</span>
    <span style="color:#080;font-weight:bold">else</span>:
        <span style="color:#080;font-weight:bold">try</span>:
            import_module(
                <span style="background-color:#fff0f0">&#39;.{0}&#39;</span><span style="color:#333">.</span>format(patch_module_name),
                <span style="background-color:#fff0f0">&#39;ZenPacks.aalvarez.ZenPack2.patches&#39;</span>)
        <span style="color:#080;font-weight:bold">except</span> <span style="color:#f00;font-weight:bold">ImportError</span>:
            log<span style="color:#333">.</span>exception(<span style="background-color:#fff0f0">&#39;failed to apply </span><span style="background-color:#eee">%s</span><span style="background-color:#fff0f0"> patches&#39;</span>, patch_module_name)


optional_import(<span style="background-color:#fff0f0">&#39;ZenPacks.aalvarez.ZenPack1&#39;</span>, <span style="background-color:#fff0f0">&#39;ZenPack1&#39;</span>)</code></pre></div>
<p>For everything that we want to monkey patch, we will call the <code>optional_import</code> function with two arguments: The required import (in this case, the first ZenPack), and the name of the file that will contain the monkey patches (in this case <code>ZenPack1</code>). This will be created later and will reside in the same location as <code>__init__.py</code>.</p>

<p>=&gt; After taking a look at official Zenoss ZenPacks that contain monkey patching, I discovered that monkey patches to the Zenoss Core source code should be placed inside a file called <code>platform.py</code>.</p>

<p>Since we used <code>ZenPack1</code> as the name (you can use any name), we will created a new file called <code>ZenPack1.py</code>:</p>

<p><strong>patches/ZenPack1.py</strong>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">logging</span>
log <span style="color:#333">=</span> logging<span style="color:#333">.</span>getLogger(<span style="background-color:#fff0f0">&#39;zen.ZenPack2&#39;</span>)

<span style="color:#080;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">Products.Zuul.infos</span> <span style="color:#080;font-weight:bold">import</span> ProxyProperty

<span style="color:#080;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">ZenPacks.aalvarez.ZenPack1.SpecialServer</span> <span style="color:#080;font-weight:bold">import</span> SpecialServer, SpecialServerInfo


<span style="color:#888"># Add new property</span>
SpecialServer<span style="color:#333">.</span>my_new_property <span style="color:#333">=</span> False
SpecialServer<span style="color:#333">.</span>_properties <span style="color:#333">+=</span> (
    {<span style="background-color:#fff0f0">&#39;id&#39;</span>: <span style="background-color:#fff0f0">&#39;my_new_property&#39;</span>, <span style="background-color:#fff0f0">&#39;type&#39;</span>: <span style="background-color:#fff0f0">&#39;boolean&#39;</span>, <span style="background-color:#fff0f0">&#39;mode&#39;</span>: <span style="background-color:#fff0f0">&#39;w&#39;</span>},
    )

<span style="color:#888"># Make the property available through the API</span>
SpcialServerInfo<span style="color:#333">.</span>my_new_property <span style="color:#333">=</span> ProxyProperty(<span style="background-color:#fff0f0">&#39;my_new_property&#39;</span>)</code></pre></div>
<p>This file is directly monkeypatching the <code>SpecialServer</code> class from the ZenPack. To understand how these classes are constructed, you can take a look at the main parent class found at <code>$ZENHOME/Products/ZenModel/Device.py</code>.</p>

<p>Apart from the <code>SpecialServer</code> class, we are also importing its Info class to also assign the new property. This will make the property available through the API. Meaning that you can use the Zenoss JSON API to query the device information. This new property will be included in the JSON response results.</p>

<p>-&gt; Info classes define a mapping between object attributes and interface classes for display in the GUI.
<br><br>
In ZenPacks, Info classes are located in <code>info.py</code> file. However when using ZenPackLib this is no longer necessary since ZenPackLib takes care of generating the necessary Info code from the YAML file.
<br><br>
The info.py file abstracts object attribute information saved in the Zope Object Database
(ZODB), that will be displayed to the user.</p>

<p>Lastly we need to add all this monkey patching logic to the installation process. This is done at the end of the ZenPack&rsquo;s main <code>__init__.py</code> file:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888"># YAML loading here ...</span>

<span style="color:#888"># ...</span>

<span style="color:#888"># Patch last to avoid import recursion problems</span>
<span style="color:#080;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">.</span> <span style="color:#080;font-weight:bold">import</span> patches</code></pre></div>
<p>And now our monkey patching is completed. When the ZenPack is installed, the new property will be added to <code>ZenPack1</code>&rsquo;s <code>SpecialServer</code> class.</p>

<h2 id="references">References</h2>

<ol>
<li><a href="http://zenpackers.readthedocs.io/en/latest/monkeypatching.html">Monkey Patching in ZenPacks</a></li>
<li>ZenPack Developer&rsquo;s Guide v1.0.1 - Jane Curry, page 176</li>
</ol>
</div>


<div style="margin: 20px 0px;">
  
    <a href="http://aalvarez.me/tags/zenoss" class="label label-default">zenoss</a></li>
  
    <a href="http://aalvarez.me/tags/python" class="label label-default">python</a></li>
  
    <a href="http://aalvarez.me/tags/zenpacklib" class="label label-default">zenpacklib</a></li>
  
    <a href="http://aalvarez.me/tags/zenpacks" class="label label-default">zenpacks</a></li>
  
    <a href="http://aalvarez.me/tags/zope" class="label label-default">zope</a></li>
  
</div>


<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "aalvarez-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>

    
  </body>
</html>
