<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.52" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Pytest Tricks for Better Python Tests &middot; Andrés Álvarez</title>

  
  <link type="text/css" rel="stylesheet" href="https://aalvarez.me/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://aalvarez.me/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://aalvarez.me/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://aalvarez.me/css/hyde.css">
  <link type="text/css" rel="stylesheet" href="https://aalvarez.me/css/extra.css">
  <link type="text/css" rel="stylesheet" href="https://aalvarez.me/css/overrides.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Andrés Álvarez" />

  
</head>

  <body class="theme-base-08 ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://aalvarez.me/"><h1>Andrés Álvarez</h1></a>
      <p class="lead">
       Software Engineer &amp; Web Developer 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://aalvarez.me/">Home</a> </li>
        <li><a href="/tags/">Tags</a></li>
        <li><a href="/about/"> About Me </a></li><li><a href="/portfolio/"> Portfolio </a></li>
      </ul>
    </nav>

    
    <ul id="social-media" class="list-inline">
      
        <li>
           <a href="mailto:andresalvarez353@gmail.com" target="_blank"><i class="fa fa-envelope fa-2x" title="E-Mail"></i></a>
        </li>
      

      
        <li>
          <a href="https://linkedin.com/in/aalvarez4" target="_blank"><i class="fa fa-linkedin fa-2x" title="LinkedIn"></i></a>
        </li>
      

      
        <li>
          <a href="https://github.com/BigChief45" target="_blank"><i class="fa fa-github fa-2x" title="Github"></i></a>
        </li>
      

      
        <li>
          <a href="https://www.instagram.com/aalvarez300" target="_blank"><i class="fa fa-instagram fa-2x" title="Instagram"></i></a>
        </li>
      

      
        <li>
          <a href="/index.xml" target="_blank"><i class="fa fa-rss fa-2x" title="RSS"></i></a>
        </li>
      
    </ul>

    <p>&copy; 2018. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Pytest Tricks for Better Python Tests</h1>
  <time datetime=2018-12-21T21:03:28Z class="post-date">Fri, Dec 21, 2018</time>

  <p><a href="https://pytest.org/">Pytest</a> is my Python testing framework of choice. Very easy to use, and makes tests look much better.</p>

<p>In this article I&rsquo;ll show you some cool tricks I have incorporated into my test suites using Pytest.</p>

<h2 id="environment-variables">Environment Variables</h2>

<p>When your application must work with defined environment variables, the testing environment must have these variables defined as well, even if the values are not real.</p>

<p>With Pytest we can easily configure any necessary environment variables in our test environment. We simply create a fixture in <code>conftest.py</code> that will be loaded automatically:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888"># conftest.py</span>

<span style="color:#080;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">pytest</span>


<span style="color:#555;font-weight:bold">@pytest.fixture</span>(autouse<span style="color:#333">=</span>True)
<span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">env_setup</span>(monkeypatch):
    monkeypatch<span style="color:#333">.</span>setenv(<span style="background-color:#fff0f0">&#39;MY_SETTING&#39;</span>, <span style="background-color:#fff0f0">&#39;some-value&#39;</span>)
    monkeypatch<span style="color:#333">.</span>setenv(<span style="background-color:#fff0f0">&#39;ANOTHER_SETTING&#39;</span>, <span style="background-color:#fff0f0">&#39;some-value&#39;</span>)</code></pre></div>
<p><a href="https://docs.pytest.org/en/latest/monkeypatch.html"><code>monkeypatch</code></a> is a built-in pytest fixture that allows us to set environment variables in the test runs. By enabling the <code>autouse</code> option, our custom environment setup fixture will be automatically called in every test without having to include it explicitly using the usual dependency injection mechanism.</p>

<h2 id="aws-mock-fixtures">AWS Mock Fixtures</h2>

<p>We can create reusable fixtures that mock AWS services, using the awesome <a href="https://github.com/spulec/moto">moto</a> library:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888"># conftest.py</span>

<span style="color:#080;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">pytest</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">moto</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">boto3</span>


TEST_BUCKET_NAME <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#39;test-bucket&#39;</span>
TEST_DYNAMO_TABLE_NAME <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#39;test-dynamodb-table&#39;</span>


<span style="color:#555;font-weight:bold">@pytest.fixture</span>
<span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">s3_bucket</span>():
    <span style="color:#080;font-weight:bold">with</span> moto<span style="color:#333">.</span>mock_s3():
        boto3<span style="color:#333">.</span>client(<span style="background-color:#fff0f0">&#39;s3&#39;</span>)<span style="color:#333">.</span>create_bucket(Bucket<span style="color:#333">=</span>TEST_BUCKET_NAME)
        <span style="color:#080;font-weight:bold">yield</span> boto3<span style="color:#333">.</span>resource(<span style="background-color:#fff0f0">&#39;s3&#39;</span>)<span style="color:#333">.</span>Bucket(TEST_BUCKET_NAME)


<span style="color:#555;font-weight:bold">@pytest.fixture</span>
<span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">dynamodb_table</span>():
    <span style="color:#080;font-weight:bold">with</span> moto<span style="color:#333">.</span>mock_dynamodb2():
        boto3<span style="color:#333">.</span>client(<span style="background-color:#fff0f0">&#39;dynamodb&#39;</span>)<span style="color:#333">.</span>create_table(
            AttributeDefinitions<span style="color:#333">=</span>[
                {<span style="background-color:#fff0f0">&#39;AttributeName&#39;</span>: <span style="background-color:#fff0f0">&#39;id&#39;</span>, <span style="background-color:#fff0f0">&#39;AttributeType&#39;</span>: <span style="background-color:#fff0f0">&#39;S&#39;</span>}
            ],
            TableName<span style="color:#333">=</span>TEST_DYNAMO_TABLE_NAME,
            KeySchema<span style="color:#333">=</span>[{<span style="background-color:#fff0f0">&#39;AttributeName&#39;</span>: <span style="background-color:#fff0f0">&#39;id&#39;</span>, <span style="background-color:#fff0f0">&#39;KeyType&#39;</span>: <span style="background-color:#fff0f0">&#39;HASH&#39;</span>}],
            ProvisionedThroughput<span style="color:#333">=</span>{
                <span style="background-color:#fff0f0">&#39;ReadCapacityUnits&#39;</span>: <span style="color:#00d;font-weight:bold">123</span>,
                <span style="background-color:#fff0f0">&#39;WriteCapacityUnits&#39;</span>: <span style="color:#00d;font-weight:bold">123</span>,
            },
        )
        <span style="color:#080;font-weight:bold">yield</span> boto3<span style="color:#333">.</span>resource(<span style="background-color:#fff0f0">&#39;dynamodb&#39;</span>)<span style="color:#333">.</span>Table(TEST_DYNAMO_TABLE_NAME)</code></pre></div>
<p>The <code>yield</code> keyword in the fixture will allow this fixture to be kept alive during the whole execution of a test that uses it. Using these fixtures in tests is very straight-forward:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyTest</span>:
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">test_upload</span>(self, s3_bucket):
        <span style="color:#888"># Call some function that uploads some files</span>
        <span style="color:#888"># to S3 under a &#39;directory&#39;</span>
        my_func()

        <span style="color:#888"># Assert that the file is in the bucket</span>
        <span style="color:#080;font-weight:bold">assert</span> <span style="color:#007020">len</span>(<span style="color:#007020">list</span>(s3_bucket<span style="color:#333">.</span>objects<span style="color:#333">.</span><span style="color:#007020">filter</span>(Prefix<span style="color:#333">=</span>f<span style="background-color:#fff0f0">&#39;{SOME_ID}/&#39;</span>))) <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">3</span></code></pre></div>
<h2 id="fixtures-that-accept-arguments">Fixtures That Accept Arguments</h2>

<p>There are times when I want to write some sort of fixture factory that can produce fixtures with different properties depending on parameters passed to it.</p>

<p>For example, let&rsquo;s say we want a fixture that represents some JSON payload, but some values should be generated according to some identifier that is passed to the fixture. A real example of this would be a JSON payload of an <a href="https://aws.amazon.com/sqs/">Amazon SQS</a> event that gets triggered when some file is uploaded to a S3 bucket:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888"># conftest.py</span>

<span style="color:#080;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">pytest</span>


<span style="color:#555;font-weight:bold">@pytest.fixture</span>
<span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">sqs_event_payload</span>():
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">_payload</span>(<span style="color:#007020">id</span>):
        s3_key <span style="color:#333">=</span> f<span style="background-color:#fff0f0">&#39;{id}/{id}.pdf&#39;</span>

         msg <span style="color:#333">=</span> {
            <span style="background-color:#fff0f0">&#39;Records&#39;</span>: [
                {
                    <span style="background-color:#fff0f0">&#39;s3&#39;</span>: {
                        <span style="background-color:#fff0f0">&#39;bucket&#39;</span>: {<span style="background-color:#fff0f0">&#39;name&#39;</span>: TEST_BUCKET_NAME},
                        <span style="background-color:#fff0f0">&#39;object&#39;</span>: {<span style="background-color:#fff0f0">&#39;key&#39;</span>: s3_key},
                    }
                }
            ]
        }
        body <span style="color:#333">=</span> {<span style="background-color:#fff0f0">&#39;Message&#39;</span>: json<span style="color:#333">.</span>dumps(msg)}
        <span style="color:#080;font-weight:bold">return</span> {<span style="background-color:#fff0f0">&#39;Records&#39;</span>: [{<span style="background-color:#fff0f0">&#39;body&#39;</span>: json<span style="color:#333">.</span>dumps(body)}]}

    <span style="color:#080;font-weight:bold">return</span> _payload</code></pre></div>
<p>The trick here is using an inner function to enabling the &ldquo;parameterization&rdquo; of the fixture. We can then use it in a test like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyTest</span>:
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">test_something</span>(self, sqs_event_payload):
        payload <span style="color:#333">=</span> sqs_event_payload(<span style="background-color:#fff0f0">&#39;1093450983456&#39;</span>)

        <span style="color:#888"># Send the payload to what we want to test</span>
        r <span style="color:#333">=</span> some_function(payload)

        <span style="color:#888"># Assert something here...</span></code></pre></div>
<p>This allows us to be able to specify a dynamic ID to the fixture. This way we don&rsquo;t have to worry about using the same ID in every test.</p>

<p>One drawback of this trick though, is that we have to call the fixture as a function first to be able to use it, as opposed to the normal way of using fixtures by just referring to them.</p>
</div>


<div style="margin: 20px 0px;">
  
    <a href="https://aalvarez.me/tags/python" class="label label-default">python</a></li>
  
    <a href="https://aalvarez.me/tags/pytest" class="label label-default">pytest</a></li>
  
</div>


<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "aalvarez-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>

    
  </body>
</html>
