<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.52" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Understanding Gnocchi Metrics &middot; Andrés Álvarez</title>

  
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/hyde.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/extra.css">
  <link type="text/css" rel="stylesheet" href="http://aalvarez.me/css/overrides.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Andrés Álvarez" />

  
</head>

  <body class="theme-base-08 ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://aalvarez.me/"><h1>Andrés Álvarez</h1></a>
      <p class="lead">
       Software Engineer &amp; Web Developer 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="http://aalvarez.me/">Home</a> </li>
        <li><a href="/tags/">Tags</a></li>
        <li><a href="/about/"> About Me </a></li><li><a href="/portfolio/"> Portfolio </a></li>
      </ul>
    </nav>

    
    <ul id="social-media" class="list-inline">
      
        <li>
           <a href="mailto:andresalvarez353@gmail.com" target="_blank"><i class="fa fa-envelope fa-2x" title="E-Mail"></i></a>
        </li>
      

      
        <li>
          <a href="https://linkedin.com/in/aalvarez4" target="_blank"><i class="fa fa-linkedin fa-2x" title="LinkedIn"></i></a>
        </li>
      

      
        <li>
          <a href="https://github.com/BigChief45" target="_blank"><i class="fa fa-github fa-2x" title="Github"></i></a>
        </li>
      

      
        <li>
          <a href="https://www.instagram.com/aalvarez300" target="_blank"><i class="fa fa-instagram fa-2x" title="Instagram"></i></a>
        </li>
      

      
        <li>
          <a href="/feed.xml" target="_blank"><i class="fa fa-rss fa-2x" title="RSS"></i></a>
        </li>
      
    </ul>

    <p>&copy; 2018. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Understanding Gnocchi Metrics</h1>
  <time datetime=2017-05-18T00:00:00Z class="post-date">Thu, May 18, 2017</time>

  <p>Metrics are one of the main object types in Gnocchi. They are identified by a UUID and they can also be attached to a resource by using a resource name. Metrics store <strong>measures</strong>, and the way they do this is defined by <strong>archive policies</strong>. These are concepts that I will cover in future articles.</p>

<p>Basically, a metric designates any thing that can be measured: the CPU usage of a server, the temperature of a room or the number of bytes sent by a network interface.</p>

<p><img src="http://gnocchi.xyz/_images/architecture.png" alt="Gnocchi Architecture" /></p>

<p>In the Gnocchi architecture, the <strong>storage</strong> back-end is responsible for storing measures of created metrics. It receives timestamps and values, and pre-computes aggregations according to the defined archive policies.</p>

<h2 id="interacting-with-metrics-using-the-api">Interacting With Metrics Using the API</h2>

<p>Using the Gnocchi REST API, a metric can be created by simply passing an archive policy:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-http" data-lang="http"><span style="color:#06b;font-weight:bold">POST</span> <span style="color:#0e84b5;font-weight:bold">/v1/metric</span> <span style="color:#080;font-weight:bold">HTTP</span><span style="color:#333">/</span><span style="color:#60e;font-weight:bold">1.1</span>
Content-Length<span style="color:#333">:</span> 35
Content-Type<span style="color:#333">:</span> application/json

{
  <span style="color:#070">&#34;archive_policy_name&#34;</span>: <span style="background-color:#fff0f0">&#34;high&#34;</span>
}</code></pre></div>
<p>The API will respond with a created <code>201 CREATED</code> status code and some information about the created metric:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-http" data-lang="http"><span style="color:#080;font-weight:bold">HTTP</span><span style="color:#333">/</span><span style="color:#60e;font-weight:bold">1.1</span> <span style="color:#60e;font-weight:bold">201</span> <span style="color:#f00;font-weight:bold">Created</span>
Location<span style="color:#333">:</span> http://localhost/v1/metric/4c964d57-9d67-4c49-bc61-d48d15b705c6
Content-Length<span style="color:#333">:</span> 206
Content-Type<span style="color:#333">:</span> application/json

{
  <span style="color:#070">&#34;archive_policy_name&#34;</span>: <span style="background-color:#fff0f0">&#34;high&#34;</span>,
  <span style="color:#070">&#34;created_by_project_id&#34;</span>: <span style="background-color:#fff0f0">&#34;&#34;</span>,
  <span style="color:#070">&#34;created_by_user_id&#34;</span>: <span style="background-color:#fff0f0">&#34;admin&#34;</span>,
  <span style="color:#070">&#34;creator&#34;</span>: <span style="background-color:#fff0f0">&#34;admin&#34;</span>,
  <span style="color:#070">&#34;id&#34;</span>: <span style="background-color:#fff0f0">&#34;4c964d57-9d67-4c49-bc61-d48d15b705c6&#34;</span>,
  <span style="color:#070">&#34;name&#34;</span>: <span style="color:#080;font-weight:bold">null</span>,
  <span style="color:#070">&#34;resource_id&#34;</span>: <span style="color:#080;font-weight:bold">null</span>,
  <span style="color:#070">&#34;unit&#34;</span>: <span style="color:#080;font-weight:bold">null</span>
}</code></pre></div>
<p>We can then retrieve the complete information of this metric by using its UUID:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-http" data-lang="http"><span style="color:#06b;font-weight:bold">GET</span> <span style="color:#0e84b5;font-weight:bold">/v1/metric/4c964d57-9d67-4c49-bc61-d48d15b705c6</span> <span style="color:#080;font-weight:bold">HTTP</span><span style="color:#333">/</span><span style="color:#60e;font-weight:bold">1.1</span>
Content-Length<span style="color:#333">:</span> 0</code></pre></div>
<p>The response will be:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-http" data-lang="http"><span style="color:#080;font-weight:bold">HTTP</span><span style="color:#333">/</span><span style="color:#60e;font-weight:bold">1.1</span> <span style="color:#60e;font-weight:bold">200</span> <span style="color:#f00;font-weight:bold">OK</span>
Content-Length<span style="color:#333">:</span> 532
Content-Type<span style="color:#333">:</span> application/json

{
  <span style="color:#070">&#34;archive_policy&#34;</span>: {
    <span style="color:#070">&#34;aggregation_methods&#34;</span>: [
      <span style="background-color:#fff0f0">&#34;min&#34;</span>,
      <span style="background-color:#fff0f0">&#34;count&#34;</span>,
      <span style="background-color:#fff0f0">&#34;max&#34;</span>,
      <span style="background-color:#fff0f0">&#34;std&#34;</span>,
      <span style="background-color:#fff0f0">&#34;sum&#34;</span>,
      <span style="background-color:#fff0f0">&#34;mean&#34;</span>
    ],
    <span style="color:#070">&#34;back_window&#34;</span>: <span style="color:#00d;font-weight:bold">0</span>,
    <span style="color:#070">&#34;definition&#34;</span>: [
      {
        <span style="color:#070">&#34;granularity&#34;</span>: <span style="background-color:#fff0f0">&#34;0:00:01&#34;</span>,
        <span style="color:#070">&#34;points&#34;</span>: <span style="color:#00d;font-weight:bold">3600</span>,
        <span style="color:#070">&#34;timespan&#34;</span>: <span style="background-color:#fff0f0">&#34;1:00:00&#34;</span>
      },
      {
        <span style="color:#070">&#34;granularity&#34;</span>: <span style="background-color:#fff0f0">&#34;0:01:00&#34;</span>,
        <span style="color:#070">&#34;points&#34;</span>: <span style="color:#00d;font-weight:bold">10080</span>,
        <span style="color:#070">&#34;timespan&#34;</span>: <span style="background-color:#fff0f0">&#34;7 days, 0:00:00&#34;</span>
      },
      {
        <span style="color:#070">&#34;granularity&#34;</span>: <span style="background-color:#fff0f0">&#34;1:00:00&#34;</span>,
        <span style="color:#070">&#34;points&#34;</span>: <span style="color:#00d;font-weight:bold">8760</span>,
        <span style="color:#070">&#34;timespan&#34;</span>: <span style="background-color:#fff0f0">&#34;365 days, 0:00:00&#34;</span>
      }
    ],
    <span style="color:#070">&#34;name&#34;</span>: <span style="background-color:#fff0f0">&#34;high&#34;</span>
  },
  <span style="color:#070">&#34;created_by_project_id&#34;</span>: <span style="background-color:#fff0f0">&#34;&#34;</span>,
  <span style="color:#070">&#34;created_by_user_id&#34;</span>: <span style="background-color:#fff0f0">&#34;admin&#34;</span>,
  <span style="color:#070">&#34;creator&#34;</span>: <span style="background-color:#fff0f0">&#34;admin&#34;</span>,
  <span style="color:#070">&#34;id&#34;</span>: <span style="background-color:#fff0f0">&#34;4c964d57-9d67-4c49-bc61-d48d15b705c6&#34;</span>,
  <span style="color:#070">&#34;name&#34;</span>: <span style="color:#080;font-weight:bold">null</span>,
  <span style="color:#070">&#34;resource&#34;</span>: <span style="color:#080;font-weight:bold">null</span>,
  <span style="color:#070">&#34;unit&#34;</span>: <span style="color:#080;font-weight:bold">null</span>
}</code></pre></div>
<h2 id="metric-source-code">Metric Source Code</h2>

<p>Source code for the Metric object can be found in <a href="https://github.com/openstack/gnocchi/blob/master/gnocchi/storage/__init__.py"><code>storage/__init__.py</code></a>:</p>

<p><strong>storage/<strong>init</strong>.py</strong>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">Metric</span>(<span style="color:#007020">object</span>):
    <span style="color:#080;font-weight:bold">def</span> __init__(self, <span style="color:#007020">id</span>, archive_policy,
                 creator<span style="color:#333">=</span>None,
                 name<span style="color:#333">=</span>None,
                 resource_id<span style="color:#333">=</span>None):
        self<span style="color:#333">.</span><span style="color:#007020">id</span> <span style="color:#333">=</span> <span style="color:#007020">id</span>
        self<span style="color:#333">.</span>archive_policy <span style="color:#333">=</span> archive_policy
        self<span style="color:#333">.</span>creator <span style="color:#333">=</span> creator
        self<span style="color:#333">.</span>name <span style="color:#333">=</span> name
        self<span style="color:#333">.</span>resource_id <span style="color:#333">=</span> resource_id

    <span style="color:#080;font-weight:bold">def</span> __repr__(self):
        <span style="color:#080;font-weight:bold">return</span> <span style="background-color:#fff0f0">&#39;&lt;</span><span style="background-color:#eee">%s</span><span style="background-color:#fff0f0"> </span><span style="background-color:#eee">%s</span><span style="background-color:#fff0f0">&gt;&#39;</span> <span style="color:#333">%</span> (self<span style="color:#333">.</span>__class__<span style="color:#333">.</span>__name__, self<span style="color:#333">.</span><span style="color:#007020">id</span>)

    <span style="color:#080;font-weight:bold">def</span> __str__(self):
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#007020">str</span>(self<span style="color:#333">.</span><span style="color:#007020">id</span>)

    <span style="color:#080;font-weight:bold">def</span> __eq__(self, other):
        <span style="color:#080;font-weight:bold">return</span> (<span style="color:#007020">isinstance</span>(other, Metric)
                <span style="color:#000;font-weight:bold">and</span> self<span style="color:#333">.</span><span style="color:#007020">id</span> <span style="color:#333">==</span> other<span style="color:#333">.</span><span style="color:#007020">id</span>
                <span style="color:#000;font-weight:bold">and</span> self<span style="color:#333">.</span>archive_policy <span style="color:#333">==</span> other<span style="color:#333">.</span>archive_policy
                <span style="color:#000;font-weight:bold">and</span> self<span style="color:#333">.</span>creator <span style="color:#333">==</span> other<span style="color:#333">.</span>creator
                <span style="color:#000;font-weight:bold">and</span> self<span style="color:#333">.</span>name <span style="color:#333">==</span> other<span style="color:#333">.</span>name
                <span style="color:#000;font-weight:bold">and</span> self<span style="color:#333">.</span>resource_id <span style="color:#333">==</span> other<span style="color:#333">.</span>resource_id)

__hash__ <span style="color:#333">=</span> <span style="color:#007020">object</span><span style="color:#333">.</span>__hash__</code></pre></div>
<p>Some exceptions related to metrics are also defined here. For example:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MetricAlreadyExists</span>(StorageError):
    <span style="background-color:#fff0f0">&#34;&#34;&#34;Error raised when this metric already exists.&#34;&#34;&#34;</span>

    <span style="color:#080;font-weight:bold">def</span> __init__(self, metric):
        self<span style="color:#333">.</span>metric <span style="color:#333">=</span> metric
        <span style="color:#007020">super</span>(MetricAlreadyExists, self)<span style="color:#333">.</span>__init__(
            <span style="background-color:#fff0f0">&#34;Metric </span><span style="background-color:#eee">%s</span><span style="background-color:#fff0f0"> already exists&#34;</span> <span style="color:#333">%</span> metric)

<span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">LockedMetric</span>(StorageError):
    <span style="background-color:#fff0f0">&#34;&#34;&#34;Error raised when this metric is already being handled by another.&#34;&#34;&#34;</span>

    <span style="color:#080;font-weight:bold">def</span> __init__(self, metric):
        self<span style="color:#333">.</span>metric <span style="color:#333">=</span> metric
        <span style="color:#007020">super</span>(LockedMetric, self)<span style="color:#333">.</span>__init__(<span style="background-color:#fff0f0">&#34;Metric </span><span style="background-color:#eee">%s</span><span style="background-color:#fff0f0"> is locked&#34;</span> <span style="color:#333">%</span> metric)</code></pre></div>
<p>We can see these exceptions being raised by the drivers, which are also located in <code>/storage/</code>. For example, when the <a href="https://github.com/openstack/gnocchi/blob/master/gnocchi/storage/file.py">file driver</a> is trying to create a metric:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">_create_metric</span>(self, metric):
        path <span style="color:#333">=</span> self<span style="color:#333">.</span>_build_metric_dir(metric)
        <span style="color:#080;font-weight:bold">try</span>:
            os<span style="color:#333">.</span>mkdir(path, <span style="color:#00d;font-weight:bold">0</span>o750)
        <span style="color:#080;font-weight:bold">except</span> <span style="color:#f00;font-weight:bold">OSError</span> <span style="color:#080;font-weight:bold">as</span> e:
            <span style="color:#080;font-weight:bold">if</span> e<span style="color:#333">.</span>errno <span style="color:#333">==</span> errno<span style="color:#333">.</span>EEXIST:
                <span style="color:#080;font-weight:bold">raise</span> storage<span style="color:#333">.</span>MetricAlreadyExists(metric)
            <span style="color:#080;font-weight:bold">raise</span>
        <span style="color:#080;font-weight:bold">for</span> agg <span style="color:#000;font-weight:bold">in</span> metric<span style="color:#333">.</span>archive_policy<span style="color:#333">.</span>aggregation_methods:
            <span style="color:#080;font-weight:bold">try</span>:
                os<span style="color:#333">.</span>mkdir(self<span style="color:#333">.</span>_build_metric_path(metric, agg), <span style="color:#00d;font-weight:bold">0</span>o750)
            <span style="color:#080;font-weight:bold">except</span> <span style="color:#f00;font-weight:bold">OSError</span> <span style="color:#080;font-weight:bold">as</span> e:
                <span style="color:#080;font-weight:bold">if</span> e<span style="color:#333">.</span>errno <span style="color:#333">!=</span> errno<span style="color:#333">.</span>EEXIST:
                    <span style="color:#080;font-weight:bold">raise</span></code></pre></div>
<p>Since the file driver storages the metric data in the file system using actual <em>files</em>, when a file already exists, a system error will be produced and the <code>OSError</code> exception will be catched.</p>

<p>This storage module makes use of the Python <a href="https://docs.python.org/2/library/errno.html"><code>errno</code> module</a>, which provides standard system <code>errno</code> symbols. In this case, the exception&rsquo;s <code>errno</code> would be <code>EEXIST</code>, indicating the <a href="https://docs.python.org/2/library/errno.html#errno.EEXIST">file already exists</a>. The <code>MetricAlreadyExists</code> exception is then raised.</p>

<h2 id="interacting-with-metrics-using-the-gnocchi-client">Interacting With Metrics Using the Gnocchi Client</h2>

<p>With the <a href="http://gnocchi.xyz/gnocchiclient/index.html">gnocchi client</a>, we can create metrics like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">gnocchi<span style="color:#333">.</span>metric<span style="color:#333">.</span>create({
        <span style="background-color:#fff0f0">&#39;name&#39;</span>: <span style="background-color:#fff0f0">&#39;my_metric&#39;</span>,
        <span style="background-color:#fff0f0">&#39;archive_policy_name&#39;</span>: <span style="background-color:#fff0f0">&#39;high&#39;</span>,
})</code></pre></div>
<p>And we can delete it by passing the metric&rsquo;s UUID (if there is no resource ID) like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">gnocchi<span style="color:#333">.</span>metric<span style="color:#333">.</span>delete(metric<span style="color:#333">=</span><span style="background-color:#fff0f0">&#39;1c0f69bf-67bb-4080-8e7c-53723f7e6194&#39;</span>)</code></pre></div>
</div>


<div style="margin: 20px 0px;">
  
    <a href="http://aalvarez.me/tags/gnocchi" class="label label-default">gnocchi</a></li>
  
    <a href="http://aalvarez.me/tags/openstack" class="label label-default">openstack</a></li>
  
    <a href="http://aalvarez.me/tags/python" class="label label-default">python</a></li>
  
</div>


<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "aalvarez-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>

    
  </body>
</html>
